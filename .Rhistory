row.names(host.df) <- host.df$locality
dd <- as.dist(1-cor(t(host.df[,2:4])))
hc <- hclust(dd, method="complete")
q <- ggdendrogram(hc,  labels=F) + geom_hline(yintercept=0.5, lty=2) + ylim(c(0,2.2)) + xlim(c(0.5,27)) + theme_dendro()
plot_grid(q, p,labels=c('A','B'), nrow = 2)
plot_grid(q, p,labels=c('A','B'), nrow = 2, rel_heights = c(1,2))
############### load occurrence points
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T)  ## supplemental file from https://doi.org/10.1073/pnas.1908707117
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
coordinates(whost) <- ~lon+lat
whost
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
################  load gps points for experimental studies
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localities
meta <- read.csv('SI.dat.1.30.20.csv')
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
,
meta <- subset(meta, emergence != "NA") # 27 localitiesm
################  load gps points for experimental studies
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localitiesm
meta.coords <- meta %>% select(lat,lon,locality) %>% unique()
meta.coords <- meta %>% dplyr::select(lat,lon,locality) %>% unique()
coordinates(meta.coords) <- ~lon + lat
projection(meta.coords) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
################ create circles within radius of metaanalyses
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 50km
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
whost
meta.coords
################ create circles within radius of metaanalyses
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 50km
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
ovr
pol.50
meta.coords
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
coordinates(meta.coords) <- ~lon + lat
projection(meta.coords) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
################ create circles within radius of metaanalyses
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 50km
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
i <- which(is.na(ovr))##in ocean
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
shgeo.50km <- subset(whost, !(row(whost)[,1] %in% i)) # 72 observations
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
whost.df <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
whost.df$meta <- NA
meta.coords$mill <- NA
meta.coords$sorg <- NA
meta.coords$maiz <- NA
for (i in 1:length(meta.coords)){
poi <- cbind.data.frame(meta.coords$lon[i],meta.coords$lat[i])
poi.50 <- circles(poi, d=50000, lonlat=T)
poi.pol <- polygons(poi.50)
ovr <- over(whost, poi.pol)
i.ovr <- which(is.na(ovr))
meta.coords$mill[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$millet)
meta.coords$sorg[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$sorghum)
meta.coords$maiz[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$maize)
}
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
whost.df <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
whost.df$meta <- NA
for (i in 1:length(meta.coords)){
poi <- cbind.data.frame(meta.coords$lon[i],meta.coords$lat[i])
poi.50 <- circles(poi, d=50000, lonlat=T)
poi.pol <- polygons(poi.50)
ovr <- over(whost, poi.pol)
i.ovr <- which(is.na(ovr))
meta.coords$mill[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$millet)
meta.coords$sorg[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$sorghum)
meta.coords$maiz[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$maize)
}
meta.coords
as.data.frame(meta.coords)
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T)  ## supplemental file from https://doi.org/10.1073/pnas.1908707117
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localitiesm
meta.coords <- meta %>% dplyr::select(lat,lon,locality) %>% unique()
coordinates(meta.coords) <- ~lon + lat
projection(meta.coords) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 50km
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
i <- which(is.na(ovr))##in ocean
shgeo.50km <- subset(whost, !(row(whost)[,1] %in% i)) # 72 observations
whost.df <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
whost.df$meta <- NA
meta.coords$mill <- NA
meta.coords$sorg <- NA
meta.coords$maiz <- NA
for (i in 1:length(meta.coords)){
poi <- cbind.data.frame(meta.coords$lon[i],meta.coords$lat[i])
poi.50 <- circles(poi, d=50000, lonlat=T)
poi.pol <- polygons(poi.50)
ovr <- over(whost, poi.pol)
i.ovr <- which(is.na(ovr))
meta.coords$mill[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$millet)
meta.coords$sorg[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$sorghum)
meta.coords$maiz[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$maize)
}
meta.coords
as.data.frame(meta.coords)
meta.coords
################ create circles within radius of metaanalyses
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 50km
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
i <- which(is.na(ovr))##in ocean
i
shgeo.50km <- subset(whost, !(row(whost)[,1] %in% i)) # 72 observations
shgeo.50km
as.data.frame(shgeo.50km)
############### load occurrence points
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T)  ## supplemental file from https://doi.org/10.1073/pnas.1908707117
shgeo
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
whost
?ovr
??over
################ create circles within radius of metaanalyses
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 50km
x.50
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
ovr <- over(whost, pol.50)
ovr
i <- which(is.na(ovr))##in ocean
i
subset(whost, !(row(whost)[,1] %in% i))
as.data.frame(subset(whost, !(row(whost)[,1] %in% i)))
as.data.frame(subset(whost.df, !(row(whost.df)[,1] %in% i)))
subset(whost.df, !(row(whost.df)[,1] %in% i)
)
subset(whost, !(row(whost)[,1] %in% i)
)
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
shgeo.50km <- subset(whost, !(row(whost)[,1] %in% i)) # 72 observations
shgeo.50km
(whost, !(row(whost)[,1] %in% i)) # 72 observations
(whost, !(row(whost)[,1] %in% i)
i
ovr
i
length(i)
length(shgeo)
nrow(shgeo)
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
!(row(whost)[,1] %in% i)
ovr
############### load occurrence points
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T)  ## supplemental file from https://doi.org/10.1073/pnas.1908707117
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
whost
################  load gps points for experimental studies
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localitiesm
meta.coords <- meta %>% dplyr::select(lat,lon,locality) %>% unique()
coordinates(meta.coords) <- ~lon + lat
projection(meta.coords) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
################ create circles within radius of metaanalyses
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 50km
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
i <- which(is.na(ovr))##get index for values with NA
i
ovr
nrow(ovr)
length(ovr)
??over
?sp::over
!(row(whost)[,1] %in% i
)
library(raster)
library(maptools)
data(wrld_simpl)
library(raster)
library(dplyr)
library(rgdal)
library(dismo)
library(maps)
data(worldMapEnv)
library(viridis)
library(ggplot2)
library(tidyr)
library(lme4)
library(pals)
library(rgeos)
################  load gps points for experimental studies
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localities
tmp <- meta %>% select(locality, emergence, host) %>% group_by(locality, host) %>% summarize(emg = mean(emergence), sd = sd(emergence), n=length(emergence))
tmp2 <- tmp %>% group_by(locality) %>% summarize(total=sum(emg))
tmp3 <- inner_join(tmp, tmp2)
ggplot(tmp3, aes(x=reorder(locality,-total), y=emg, col=host, fill=host)) + geom_bar(position="stack", stat="identity", alpha=0.4) +theme_minimal()+ scale_colour_manual(values=c('gold2','plum','sienna3')) + scale_fill_manual(values=c('gold2','plum','sienna3'))+ theme(axis.text.x=element_text(angle=90, vjust=0.2, hjust=1)) + ylab("Relative emergence") + xlab("Locality") + geom_errorbar()
################ downsample enm layer resolution to match earthstat
enm <- raster('/Users/emilywork/Downloads/all.CLY250.tif')
enm <- aggregate(enm, fact=10)
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T) # supplement from https://doi.org/10.1073/pnas.1908707117
coordinates(shgeo) <- ~lon+lat
projection(shgeo) <- CRS('+proj=longlat +datum=WGS84')
x <- circles(shgeo, d=200000, lonlat=T) #sample within radius of 200km
pol <- polygons(x)
all_within <- mask(core, pol)
############### create mask based on habitat suitability of all occurrence model and distance from striga hermonthica
core <- calc(enm, fun=function(x){ x[x < 0.1] <- NA; return(x)} )
all_within <- mask(core, pol)
################  load gps points for experimental studies
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localities
sorg <- raster('/Users/emilywork/Desktop/StrigaMacroecology/EarthStat/sorghum_HarvAreaYield_Geotiff/sorghum_HarvestedAreaHectares.tif')
sorg.yld <- raster('/Users/emilywork/Desktop/StrigaMacroecology/EarthStat/sorghum_HarvAreaYield_Geotiff/sorghum_YieldPerHectare.tif')
sorg <- crop(sorg, enm)
sorg.yld <- crop(sorg.yld, enm)
mill <- raster('/Users/emilywork/Desktop/StrigaMacroecology/EarthStat/millet_HarvAreaYield_Geotiff/millet_HarvestedAreaHectares.tif')
mill.yld <- raster('/Users/emilywork/Desktop/StrigaMacroecology/EarthStat/millet_HarvAreaYield_Geotiff/millet_YieldPerHectare.tif')
mill <- crop(mill, enm)
mill.yld <- crop(mill.yld, enm)
maiz <- raster('/Users/emilywork/Desktop/StrigaMacroecology/EarthStat/maize_HarvAreaYield_Geotiff/maize_HarvestedAreaHectares.tif')
maiz.yld <- raster('/Users/emilywork/Desktop/StrigaMacroecology/EarthStat/maize_HarvAreaYield_Geotiff/maize_YieldPerHectare.tif')
maiz <- crop(maiz, enm)
maiz.yld <- crop(maiz.yld, enm)
all.yld <- maiz.yld + mill.yld + sorg.yld
core <- calc(enm, fun=function(x){ x[x < 0.1] <- NA; return(x)} )
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T) # supplement from https://doi.org/10.1073/pnas.1908707117
coordinates(shgeo) <- ~lon+lat
projection(shgeo) <- CRS('+proj=longlat +datum=WGS84')
x <- circles(shgeo, d=200000, lonlat=T) #sample within radius of 200km
pol <- polygons(x)
all_within <- mask(core, pol)
################  load gps points for experimental studies
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localities
f.sorg <- sorg/(sorg+mill+maiz)
f.mill <- mill/(sorg+mill+maiz)
f.maiz <- maiz/(sorg+mill+maiz)
dom.s <- overlay(f.sorg, f.mill, f.maiz, fun=Vectorize(function(x,y,z){ifelse(x>=y && x>=z,1,NA)}))
dom.m <- overlay(f.sorg, f.mill, f.maiz, fun=Vectorize(function(x,y,z){ifelse(y>x && y>=z,2,NA)}))
dom.z <- overlay(f.sorg, f.mill, f.maiz, fun=Vectorize(function(x,y,z){ifelse(z>x && z>y,3,NA)}))
dom <- cover(dom.s, dom.m)
dom <- cover(dom, dom.z)
dom <- setExtent(dom, core)
dom <- mask(dom, all_within)
meta2 <- select(meta, locality, lat, lon) %>% unique()
meta2$clust <- c(3,5,16,17,5,5,16,2,16,5,5,5,5,3,5,6,3,17,2,5,5,6,3,2,3,3,3)  #symbols based on groups from clustering analysis
dom.c <- crop(dom, extent(-20,45,-20,20))
## new df for meta
meta2 <- select(meta, locality, lat, lon) %>% unique()
## new df for meta
meta2 <- dplyr::select(meta, locality, lat, lon) %>% unique()
meta2$clust <- c(3,5,16,17,5,5,16,2,16,5,5,5,5,3,5,6,3,17,2,5,5,6,3,2,3,3,3)  #symbols based on groups from clustering analysis
dom.c <- crop(dom, extent(-20,45,-20,20))
plot(dom.c, col=c('sienna3','plum','gold2'),legend=F, xaxt='n', yaxt='n', xlim=c(-20,45),ylim=c(-5,20))
legend(-5,-15, legend=c("1","2","3","4","5","6"), pch=c(17,2,3,16,5,6), box.col=NA, cex=0.5, title="Group")
legend(-18,-15, legend=c("sorghum","millet","maize"), fill=c('sienna3','plum','gold2'), box.col=NA, cex=0.5, title ="Main crop")
map(database="world", xlim=c(-20,50),ylim=c(-10,20),add=T, col="grey40", lwd=0.5, mar=NA)
points(meta2$lon,meta2$lat, pch=meta2$clus, cex=0.7)
head(meta)
############## visualization
## new df for meta
meta2 <- dplyr::select(meta, locality, lat, lon) %>% unique()
meta2
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T)
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
meta <- read.csv('SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localities
meta <- read.csv('SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localitiesm
meta.coords <- meta %>% select(lat,lon,locality) %>% unique()
coordinates(meta.coords) <- ~lon + lat
projection(meta.coords) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
###### polygons within radius of metaanalyses
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 200km
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
i <- which(is.na(ovr))##in ocean
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
shgeo.50km <- subset(whost, !(row(whost)[,1] %in% i)) # 72 observations
shgeo.50km
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T)
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
meta <- read.csv('SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localities
meta <- read.csv('SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localitiesm
meta.coords <- meta %>% select(lat,lon,locality) %>% unique()
coordinates(meta.coords) <- ~lon + lat
projection(meta.coords) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
###### polygons within radius of metaanalyses
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 200km
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
i <- which(is.na(ovr))##in ocean
i
i <- which(is.na(ovr))##in ocean
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
shgeo.50km <- subset(whost, !(row(whost)[,1] %in% i)) # 72 observations
shgeo.50km
!(row(whost)[,1] %in% i)
head(meta)
################  load gps points for experimental studies
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localitiesm
meta.coords <- meta %>% select(lat,lon,locality) %>% unique()
coordinates(meta.coords) <- ~lon + lat
projection(meta.coords) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
################  load gps points for experimental studies
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localitiesm
meta.coords <- meta %>% select(lat,lon,locality) %>% unique()
meta.coords <- meta %>% dplyr::select(lat,lon,locality) %>% unique()
coordinates(meta.coords) <- ~lon + lat
projection(meta.coords) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 200km
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
i <- which(is.na(ovr))##in ocean
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
shgeo.50km <- subset(whost, !(row(whost)[,1] %in% i)) # 72 observations
shgeo.50km
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T)
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
x.50 <- circles(meta.coords, d=50000, lonlat=T) #sample within radius of 200km
pol.50 <- polygons(x.50)
ovr <- over(whost, pol.50)
i <- which(is.na(ovr))##in ocean
whost <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
shgeo.50km <- subset(whost, !(row(whost)[,1] %in% i)) # 72 observations
shgeo.50km
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0')
whost.df <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
whost.df$meta <- NA
meta.coords$mill <- NA
meta.coords$sorg <- NA
meta.coords$maiz <- NA
###### for each experimental locality, count up the number of occurrences on each host in the vicinity
for (i in 1:length(meta.coords)){
poi <- cbind.data.frame(meta.coords$lon[i],meta.coords$lat[i])
poi.50 <- circles(poi, d=50000, lonlat=T)
poi.pol <- polygons(poi.50)
ovr <- over(whost, poi.pol)
i.ovr <- which(is.na(ovr))
meta.coords$mill[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$millet)
meta.coords$sorg[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$sorghum)
meta.coords$maiz[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$maize)
}
coordinates(whost) <- ~lon+lat
projection(whost) <- CRS('+proj=longlat +datum=WGS84 +ellps=WGS84')
whost.df <- subset(shgeo, millet == 1 | sorghum == 1 | maize==1)
whost.df$meta <- NA
meta.coords$mill <- NA
meta.coords$sorg <- NA
meta.coords$maiz <- NA
###### for each experimental locality, count up the number of occurrences on each host in the vicinity
for (i in 1:length(meta.coords)){
poi <- cbind.data.frame(meta.coords$lon[i],meta.coords$lat[i])
poi.50 <- circles(poi, d=50000, lonlat=T)
poi.pol <- polygons(poi.50)
ovr <- over(whost, poi.pol)
i.ovr <- which(is.na(ovr))
meta.coords$mill[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$millet)
meta.coords$sorg[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$sorghum)
meta.coords$maiz[i] <- sum(subset(whost.df, !(row(whost)[,1] %in% i.ovr))$maize)
}
meta.coords
as.data.frame(meta.coords)
library(raster)
library(maptools)
data(wrld_simpl)
library(raster)
library(dplyr)
library(rgdal)
library(dismo)
library(maps)
data(worldMapEnv)
library(ggplot2)
library(tidyr)
library(lme4)
library(pals)
library(rgeos)
################ downsample enm layer resolution to match earthstat
enm <- raster('/Users/emilywork/Downloads/all.CLY250.tif')
enm <- aggregate(enm, fact=10)
core <- calc(enm, fun=function(x){ x[x < 0.1] <- NA; return(x)} )
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T) # supplement from https://doi.org/10.1073/pnas.1908707117
coordinates(shgeo) <- ~lon+lat
projection(shgeo) <- CRS('+proj=longlat +datum=WGS84')
x <- circles(shgeo, d=200000, lonlat=T) #sample within radius of 200km
pol <- polygons(x)
all_within <- mask(core, pol)
meta2 <- dplyr::select(meta, locality, lat, lon) %>% unique()
meta2$clust <- c(3,5,16,17,5,5,16,2,16,5,5,5,5,3,5,6,3,17,2,5,5,6,3,2,3,3,3)  #symbols based on groups from clustering analysis
dom.c <- crop(dom, extent(-20,45,-20,20))
############## visualization
## new df for meta
meta2 <- dplyr::select(meta, locality, lat, lon) %>% unique()
meta2$clust <- c(3,5,16,17,5,5,16,2,16,5,5,5,5,3,5,6,3,17,2,5,5,6,3,2,3,3,3)  #symbols based on groups from clustering analysis
dom.c <- crop(dom, extent(-20,45,-20,20))
plot(dom.c, col=c('sienna3','plum','gold2'),legend=F, xaxt='n', yaxt='n', xlim=c(-20,45),ylim=c(-5,20))
legend(-5,-15, legend=c("1","2","3","4","5","6"), pch=c(17,2,3,16,5,6), box.col=NA, cex=0.5, title="Group")
legend(-18,-15, legend=c("sorghum","millet","maize"), fill=c('sienna3','plum','gold2'), box.col=NA, cex=0.5, title ="Main crop")
map(database="world", xlim=c(-20,50),ylim=c(-10,20),add=T, col="grey40", lwd=0.5, mar=NA)
points(meta2$lon,meta2$lat, pch=meta2$clus, cex=0.7)
scalebar(1000, xy = c(-5,-10), label=" 1000 km",type = "line", divs = 1, lwd = 2,  adj=c(0.5, -0.5), lonlat = TRUE, cex=0.6)
plot(dom, col=c('sienna3','plum','gold2'),legend=F, xaxt='n', yaxt='n', xlim=c(-20,50),ylim=c(-40,45))
legend(-5,-5, legend=c("1","2","3","4","5","6"), pch=c(17,2,3,16,5,6), box.col=NA, cex=0.5, title="Group")
#legend(-18,-15, legend=c("sorghum","millet","maize"), fill=c('sienna3','plum','gold2'), box.col=NA, cex=0.5, title ="Main crop")
map(database="world", xlim=c(-20,50),ylim=c(-40,45),add=T, col="grey40", lwd=0.5, mar=NA)
scalebar(1000, xy = c(35,-32), label=" 1000 km",type = "line", divs = 1, lwd = 2,  adj=c(0.5, -0.5), lonlat = TRUE, cex=0.6)
############## fig for relative emergence
tmp <- meta %>% select(locality, emergence, host) %>% group_by(locality, host) %>% summarize(emg = mean(emergence), sd = sd(emergence), n=length(emergence))
tmp2 <- tmp %>% group_by(locality) %>% summarize(total=sum(emg))
tmp3 <- inner_join(tmp, tmp2)
ggplot(tmp3, aes(x=reorder(locality,-total), y=emg, col=host, fill=host)) + geom_bar(position="stack", stat="identity", alpha=0.4) +theme_minimal()+ scale_colour_manual(values=c('gold2','plum','sienna3')) + scale_fill_manual(values=c('gold2','plum','sienna3'))+ theme(axis.text.x=element_text(angle=90, vjust=0.2, hjust=1)) + ylab("Relative emergence") + xlab("Locality") + geom_errorbar()
enm <- raster('/Users/emilywork/Downloads/all.CLY250.tif')
enm <- aggregate(enm, fact=10)
enm.s <- raster('/Users/emilywork/Downloads/sorg.CLY250.tif')
enm.s <- aggregate(enm.s, fact=10)
enm.z <- raster('/Users/emilywork/Downloads/maiz.CLY250.tif')
enm.z <- aggregate(enm.z, fact=10)
enm.m <- raster('/Users/emilywork/Downloads/mill.CLY250.tif')
enm.m <- aggregate(enm.m, fact=10)
sorg.yld <- raster('/Users/emilywork/Desktop/StrigaMacroecology/EarthStat/sorghum_HarvAreaYield_Geotiff/sorghum_YieldPerHectare.tif')
sorg.yld <- crop(sorg.yld, enm)
mill.yld <- raster('/Users/emilywork/Desktop/StrigaMacroecology/EarthStat/millet_HarvAreaYield_Geotiff/millet_YieldPerHectare.tif')
mill.yld <- crop(mill.yld, enm)
maiz.yld <- raster('/Users/emilywork/Desktop/StrigaMacroecology/EarthStat/maize_HarvAreaYield_Geotiff/maize_YieldPerHectare.tif')
maiz.yld <- crop(maiz.yld, enm)
all.yld <- maiz.yld + mill.yld + sorg.yld
meta <- read.csv('DataFiles/SI.dat.1.30.20.csv')
meta <- subset(meta, emergence != "NA") # 27 localities
tmp <- meta %>% group_by(locality,host) %>% summarize(Emg = mean(emergence), lat = mean(lat), lon=mean(lon))
tmp$productivity <- raster::extract(all.yld, cbind.data.frame(tmp$lon, tmp$lat))
tmp.wide <- as.data.frame(tmp %>% pivot_wider(names_from=host, values_from=Emg))
tmp.wide$spec <- NULL
for (i in 1:nrow(tmp.wide)){
highest <- max(tmp.wide[i,5:7])
sec_highest <- sort(tmp.wide[i,5:7],partial=2)[2]
min_val <- min(tmp.wide[i,5:7])
tmp.wide$pdi[i] <- ((highest - sec_highest) + (highest - min_val))/2
}
tmp.wide$pdi <- as.numeric(tmp.wide$pdi)
tmp.wide <- na.omit(tmp.wide)
############### Fig. 4F
p <- ggplot(tmp.wide, aes(x=productivity, y=pdi)) + geom_point(size=2, alpha=0.5) + ylab("PDI") + xlab("Productivity") + geom_smooth(method ="lm", col="black", lty=2, level=0.9)+theme_minimal()+theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank())
p
anova(lm(pdi ~ productivity, data=tmp.wide), lm(pdi ~ 1, data=tmp.wide), test="Chisq")
arrange(tmp.wide, -pdi)
arrange(tmp.wide, -productivity)
arrange(tmp.wide, productivity)
acsel.sub <- subset(acsel, host =="millet" | host=="maize")
shgeo <- read.csv('/Users/emilywork/Downloads/pnas.1908707117.sd03.csv', header=T)
coordinates(shgeo) <- ~lon+lat
sh.s <- subset(shgeo, sorghum==1)
sh.z <- subset(shgeo, maize==1)
sh.m <- subset(shgeo, millet==1)
# downsample shgeo so only one occurrence per grid cell
r <- enm
res(r) <- 0.01 #0.1 degree ~ 11 km
r <- extend(r, extent(r)+1)
acsel.s <- gridSample(sh.s, r, n=1)
acsel.z <- gridSample(sh.z, r, n=1)
acsel.m <- gridSample(sh.m, r, n=1)
# extract habitat suitability from enms
hs <- raster::extract(enm.s, acsel.s)
acsel.s <- as.data.frame(acsel.s)
acsel.s$host <- "sorghum"
acsel.s$hs <- hs
hs <- raster::extract(enm.z, acsel.z)
acsel.z <- as.data.frame(acsel.z)
acsel.z$host <- "maize"
acsel.z$hs <- hs
hs <- raster::extract(enm.m, acsel.m)
acsel.m <- as.data.frame(acsel.m)
acsel.m$host <- "millet"
acsel.m$hs <- hs
acsel <- rbind.data.frame(acsel.s, acsel.z, acsel.m)
acsel$prod <- raster::extract(all.yld, cbind(acsel$lon,acsel$lat))
### test
acsel.sub <- subset(acsel, host =="millet" | host=="maize")
wilcox.test(subset(acsel, host=="maize")$prod, subset(acsel, host=="sorghum")$prod, alternative="greater")
wilcox.test(subset(acsel, host=="maize")$prod, subset(acsel, host=="millet")$prod, alternative="greater")
# but not for maize vs. sorghum:
acsel.sub <- subset(acsel, host =="sorghum" | host=="maize")
wilcox.test(subset(acsel, host=="maize")$prod, subset(acsel, host=="sorghum")$prod, alternative="greater")
